@page "/weather"
@using AspireWithDapr.Shared
@using Microsoft.Extensions.Logging
@using Microsoft.AspNetCore.Components.QuickGrid
@using AspireWithDapr.Web.Generated
@* @attribute [StreamRendering(true)]
@attribute [OutputCache(Duration = 5)] *@
@rendermode InteractiveServer
@inject ILogger<Weather> Logger
@inject IWeatherApiClient WeatherClient

<PageTitle>Weather</PageTitle>

<h1>Weather</h1>

<p>This component demonstrates showing data loaded from a backend API service using GraphQL (StrawberryShake).</p>

<div style="display: flex; gap: 20px;">
    <div>
        <ul style="list-style-type: none; padding: 0;">
            @foreach (var city in SharedCollections.Cities)
            {
                <li style="margin-bottom: 8px;">
                    <button type="button" @onclick="() => SelectCity(city)" style="width: 150px; text-align: left;">@city</button>
                </li>
            }
        </ul>
    </div>

    <div style="flex: 1;">
        @if (isLoading)
        {
            <p><em>Loading...</em></p>
        }
        else if (forecasts == null || !forecasts.Any())
        {
            <p><em>No data available. Select a city to load weather forecasts.</em></p>
        }
        else
        {
            <QuickGrid Items="@forecasts.AsQueryable()" Class="table">
                <PropertyColumn Property="@(f => f.Date)" Title="Date" Format="d" Sortable="true" />
                <PropertyColumn Property="@(f => f.TemperatureC)" Title="Temp. (C)" Sortable="true" />
                <PropertyColumn Property="@(f => f.TemperatureF)" Title="Temp. (F)" Sortable="true" />
                <PropertyColumn Property="@(f => f.Summary)" Title="Summary" Sortable="true" />
            </QuickGrid>
        }
    </div>
</div>

@code {
    private string selectedCity = "";
    private List<IGetWeatherForecasts_WeatherForecasts>? forecasts;
    private bool isLoading = false;

    private async Task SelectCity(string city)
    {
        selectedCity = city;
        isLoading = true;
        Logger.LogInformation("Getting weather forecast for {city} via StrawberryShake GraphQL", selectedCity);

        try
        {
            var result = await WeatherClient.GetWeatherForecasts.ExecuteAsync(selectedCity);

            if (result.Data is { })
            {
                forecasts = [.. result.Data.WeatherForecasts];
            }
            else if (result.Errors != null)
            {
                Logger.LogError("GraphQL errors: {errors}", string.Join(", ", result.Errors.Select(e => e.Message)));
                forecasts = new List<IGetWeatherForecasts_WeatherForecasts>();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading weather forecasts for {city}", selectedCity);
            forecasts = new List<IGetWeatherForecasts_WeatherForecasts>();
        }
        finally
        {
            isLoading = false;
        }
    }
}
